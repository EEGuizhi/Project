import os
import cv2
import json
import numpy as np


SHOW_INTERVAL = 0  # (ms) (= 0 會等到按鍵按下)
IMG_FOLDER = "D:\python\interactive_keypoint_estimation\code\data\dataset16\\boostnet_labeldata\data\\test"
LABEL_PATH = "D:\python\interactive_keypoint_estimation\code\data\dataset16_512\\test.json"
PRED_COORDS_PATH = "D:\GitHub\EEGuizhi\Project\Testing\pred_keypts_data.json"
REMOVE_WORDS_IN_PRED_DATA_IMGPATH = [ "data/dataset16_512/data/test/", ".npy" ]

# # Wrong coords
# pred_coords = [
#     [  1.0064, 213.5387],
#     [ 16.0016, 215.0059],
#     [  4.8991, 213.5595],
#     [ 12.0101, 211.0068],
#     [  4.2614, 211.1200],
#     [ 16.0051, 215.0062],
#     [  8.0656, 209.9163],
#     [ 16.0252, 182.0000],
#     [ 16.0130, 229.9845],
#     [ 16.0040, 229.9931],
#     [202.0103,  28.0002],
#     [ 16.0067, 226.9937],
#     [ 16.0212, 226.9894],
#     [ 16.0093, 229.9904],
#     [ 16.0059, 229.9944],
#     [ 16.0014, 229.9985],
#     [ 32.0061, 241.9917],
#     [ 17.0038, 226.9978],
#     [ 32.0158, 238.9994],
#     [206.0054,  27.9970],
#     [ 16.0149, 229.9902],
#     [ 19.9993, 217.9954],
#     [ 16.0037, 229.9946],
#     [ 16.0160, 178.0031],
#     [ 51.9998,  24.0020],
#     [201.0187,  23.9985],
#     [ 51.9985,  24.0019],
#     [205.0011,  27.9926],
#     [ 16.0009, 229.9986],
#     [205.0036,  25.0126],
#     [ 16.0033, 226.9978],
#     [205.0007,  25.0012],
#     [ 16.0012, 229.9988],
#     [205.0013,  25.0021],
#     [ 16.0014, 182.0002],
#     [205.0016,  28.0031],
#     [ 16.0053, 182.0006],
#     [ 20.0019, 217.9924],
#     [ 16.0095, 230.9939],
#     [117.1191,  39.9199],
#     [ 51.9950,  25.0041],
#     [202.1530,  28.0822],
#     [205.0015,  29.0029],
#     [373.4973,  32.3872],
#     [ 16.0031, 229.9966],
#     [204.8976,  28.1830],
#     [ 16.0014, 222.9959],
#     [205.2303,  28.0905],
#     [205.0004,  28.0003],
#     [205.0133,  28.0297],
#     [ 16.0112, 215.0158],
#     [206.0522,  28.0313],
#     [ 16.0057, 215.0069],
#     [ 51.9823,  24.0076],
#     [246.0423,  29.0174],
#     [246.0522,  33.0477],
#     [ 16.0065, 218.9915],
#     [ 47.9939,  29.0078],
#     [ 16.0674, 225.9682],
#     [ 16.0043, 230.9973],
#     [ 16.0767, 226.9387],
#     [ 16.0070, 230.9915],
#     [ 16.1098, 225.6173],
#     [ 16.1049, 230.8851],
#     [ 15.5298, 221.5877],
#     [ 16.1140, 230.8882],
#     [ 15.8144, 221.5331],
#     [245.0194,  40.0016]
# ]

pred_coords1 = [
    [ 35.8868, 114.4011],
    [ 36.7503, 146.7134],
    [ 47.9664, 113.1459],
    [ 50.6583, 144.9537],
    [ 53.1741, 112.8179],
    [ 54.9413, 144.2836],
    [ 64.9545, 110.3961],
    [ 68.7468, 141.8062],
    [ 70.0564, 109.9682],
    [ 75.1501, 140.3098],
    [ 83.8652, 107.0853],
    [ 90.3292, 135.1781],
    [ 90.2998, 105.9262],
    [ 96.9919, 133.2593],
    [104.0942, 100.8389],
    [111.8513, 127.8583],
    [110.4596,  98.3456],
    [118.1188, 124.9342],
    [127.6449,  89.4250],
    [135.3473, 117.2196],
    [133.5101,  85.7102],
    [141.0228, 114.2538],
    [153.0635,  74.5458],
    [158.8311, 108.9249],
    [160.5556,  72.6117],
    [164.5626, 106.8290],
    [180.3402,  66.3317],
    [181.4859, 103.8161],
    [188.6658,  65.8652],
    [187.1870, 102.1657],
    [208.5357,  65.7094],
    [204.3709, 103.7002],
    [216.5674,  66.5230],
    [209.1914, 104.1823],
    [237.0141,  72.4947],
    [226.5345, 109.9895],
    [245.0177,  76.3508],
    [232.6555, 112.8123],
    [265.6225,  87.9635],
    [250.1785, 124.4678],
    [272.6586,  93.1483],
    [257.2617, 129.3803],
    [291.7706, 105.6873],
    [276.6739, 144.7784],
    [298.7507, 110.1597],
    [284.5606, 149.8873],
    [317.1417, 118.8327],
    [306.0991, 163.0396],
    [323.6659, 122.4589],
    [316.2477, 168.8129],
    [342.3784, 128.7094],
    [339.4082, 177.1950],
    [348.9256, 129.0706],
    [350.5511, 178.7205],
    [369.5330, 129.0839],
    [373.3683, 175.5540],
    [376.9115, 126.8259],
    [383.3362, 174.6692],
    [394.8525, 121.5152],
    [406.4758, 170.4191],
    [406.1552, 115.2829],
    [415.5921, 166.4198],
    [427.8649, 107.0205],
    [442.4805, 160.0591],
    [441.3063, 101.2384],
    [449.2793, 157.8797],
    [463.4275,  96.3944],
    [470.8696, 150.7605]
]

pred_coords2 = [
    [ 35.9690, 114.3766],
    [ 36.8159, 146.7098],
    [ 48.0611, 113.1223],
    [ 50.6939, 144.9337],
    [ 53.2765, 112.7858],
    [ 55.0057, 144.2078],
    [ 65.0998, 110.3726],
    [ 68.8655, 141.7768],
    [ 70.1494, 109.9568],
    [ 75.2589, 140.2684],
    [ 83.9610, 107.0646],
    [ 90.4013, 135.1874],
    [ 90.7791, 105.8638],
    [ 97.0558, 133.2631],
    [104.2885, 100.7566],
    [111.9020, 127.2632],
    [110.5602,  98.2681],
    [118.9595, 124.8811],
    [127.6997,  89.3196],
    [135.6500, 117.2067],
    [133.6428,  85.6482],
    [141.1790, 114.2647],
    [153.1729,  74.5284],
    [158.9601, 108.8987],
    [160.6532,  72.6286],
    [164.6373, 106.8565],
    [180.4044,  66.3409],
    [181.5949, 103.8385],
    [188.8018,  65.7517],
    [187.2417, 102.5562],
    [208.4806,  65.6618],
    [204.6334, 103.7760],
    [216.6883,  66.5393],
    [209.7183, 104.1819],
    [237.0674,  72.5621],
    [226.6376, 110.0209],
    [244.8413,  76.6852],
    [232.9887, 112.9134],
    [265.7650,  88.1446],
    [250.3412, 124.6299],
    [272.7493,  93.1606],
    [257.7698, 129.7337],
    [291.9701, 105.8407],
    [276.6692, 144.8824],
    [298.9139, 110.3817],
    [285.0901, 150.0510],
    [317.5135, 120.4952],
    [306.2466, 162.7037],
    [325.5571, 124.8325],
    [317.0925, 168.6161],
    [346.0880, 135.0581],
    [339.2938, 177.1850],
    [357.7082, 139.5114],
    [350.7858, 179.4699],
    [371.9335, 133.1893],
    [374.4130, 174.8069],
    [377.8824, 130.9696],
    [383.1931, 173.5215],
    [394.6264, 122.6468],
    [408.5472, 169.4194],
    [405.8805, 115.2092],
    [417.0903, 165.3031],
    [427.7945, 106.9260],
    [443.1762, 160.6787],
    [441.1465, 100.7900],
    [450.0730, 158.2977],
    [464.2091,  96.1557],
    [471.3319, 152.2646]
]


def plot_keypoints(img, label_kpt=None, pred_kpt=None):
    if label_kpt is not None:
        for coord in label_kpt:
            cv2.circle(img, (coord[1], coord[0]), 5, (255, 0, 0), -1)
    if pred_kpt is not None:
        for coord in pred_kpt:
            cv2.circle(img, (coord[1], coord[0]), 3, (0, 255, 255), -1)
    return img


def resize_keypoints(coords:np, old_size:list, new_size:list):
    scale = np.array([
        new_size[0] / old_size[0],
        new_size[1] / old_size[1]
    ])
    for coord in coords:
        coord *= scale
    return coords.astype(int).tolist()


if __name__ == "__main__":
    ### For only one image
    img = cv2.imread("D:\python\interactive_keypoint_estimation\code\data\dataset16\\boostnet_labeldata\data\\test\sunhl-1th-01-Mar-2017-310 C AP.jpg")
    print(">> pred_coords length: {}".format(len(pred_coords1)))
    pred_coords1 = np.array(pred_coords1)
    pred_coords1 = resize_keypoints(pred_coords1, [512, 256], img.shape[0:2])
    pred_coords2 = np.array(pred_coords2)
    pred_coords2 = resize_keypoints(pred_coords2, [512, 256], img.shape[0:2])
    kpt_img = plot_keypoints(img=img, label_kpt=pred_coords2, pred_kpt=pred_coords1)
    cv2.imwrite("test_detect_output.png", kpt_img)
    cv2.imshow("keypoints image", kpt_img)
    cv2.waitKey(0)
    cv2.destroyAllWindows()


    # ### For multiple images
    # # Read data
    # with open(LABEL_PATH, 'r') as f:
    #     label_data = json.loads(f.read())
    # with open(PRED_COORDS_PATH, 'r') as f:
    #     pred_data = json.loads(f.read())

    # # Show images
    # for data in pred_data:
    #     # Get image file name
    #     img_name = data["img_file"]
    #     for rm_str in REMOVE_WORDS_IN_PRED_DATA_IMGPATH:
    #         img_name = img_name.replace(rm_str, "")

    #     # Read image
    #     img = cv2.imread(os.path.join(IMG_FOLDER, img_name+".jpg"))
        
    #     # Read pred keypoints coord
    #     pred_coords = np.array(data["keypoints"][0])
    #     pred_coords = resize_keypoints(pred_coords, [512, 256], img.shape[0:2])

    #     # Read label keypoints coord
    #     for label in label_data:
    #         if img_name in label["image"]:
    #             label_coords = label["label"]
    #             break

    #     # Plot
    #     kpt_img = plot_keypoints(img=img, label_kpt=label_coords, pred_kpt=pred_coords)
    #     cv2.imshow("keypoints image", kpt_img)
    #     cv2.waitKey(SHOW_INTERVAL)
    #     cv2.destroyAllWindows()
